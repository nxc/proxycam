# Rsyslog configuration for proxycam

# Provide for UDP remote syslog reception.
module(load="imudp")
input(type="imudp" port="514" Ruleset="proxycam")

# Define templates for log files produced by Proxycam.

# Location:
#	/var/log/proxycam/CONT.log
# Purpose:
#	Logs generated by container CONT (possible values: "proxycam" or
#	"redis".
template(name="ProxycamServiceLogName" type="list") {
        constant(value="/var/log/proxycam/")
        property(name="syslogtag"
                 regex.type="ERE"
                 regex.expression="^[^/]+/([^/]+)/.*"
                 regex.submatch="1"
                 regex.nomatchmode="FIELD")
        constant(value=".log")

}

# Location:
#	/var/log/proxycam/program/PROG.log
# Purpose:
#	Logs produced by particular tasks. PROG is the name of the task.
template(name="ProxycamProgramLogName" type="list") {
        constant(value="/var/log/proxycam/service/")
	property(name="syslogtag"
	      regex.type="ERE"
	      regex.expression="(.*/)?([^\\[]+)(\\[[0-9]+\\])?:"
	      regex.submatch="2"
	      regex.nomatchmode="FIELD")
        constant(value=".log")
}

# Define a ruleset for routing remote messages.
ruleset(name="proxycam") {
	if re_match($syslogtag, "^[^/]+/[^/]+/.*") then {
		action(type="omfile" dynaFile="ProxycamServiceLogName")
        } else {
		action(type="omfile" dynaFile="ProxycamProgramLogName")
	}
	stop
}
